<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title> COHLIT - Rutgers University </title>
	<link rel="stylesheet" type="text/css" href="main.css"></link>
</head>
<body>
<div id="container"></div>

	<script type="text/javascript" src="./js/three.js"></script>
	<script type="text/javascript" src="./js/StereoEffect.js"></script>
	<script type="text/javascript" src="./js/Detector.js"></script>
	<script type="text/javascript" src="./js/DeviceOrientationControls.js"></script>
	<script type="text/javascript" src="./js/OrbitControls.js"></script>
	<script>
		if(!Detector.webgl) {
			Detector.addGetWebGLMessage();
		}
		else {
			var clock, scene, camera, renderer, container;
			var effect, controls;
			var geometry, material, cube, cube2;

			var raycaster = new THREE.Raycaster();
			var mouse = new THREE.Vector2();
			mouse.x = 0;
			mouse.y = 0;

			var create = function() {
				clock = new THREE.Clock();

				scene = new THREE.Scene();
				camera = new THREE.PerspectiveCamera(90, 1, 0.1, 15000);

				renderer = new THREE.WebGLRenderer();
				renderer.setClearColor(0xffffff, 1);
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize(window.innerWidth, window.innerHeight);
				container = document.getElementById("container");
				container.appendChild(renderer.domElement);

				effect = new THREE.StereoEffect(renderer);
				//effect.eyeSeparation = 10;
				effect.setSize(window.innerWidth, window.innerHeight);

				controls =  new THREE.OrbitControls(camera, render.domElement);
				controls.rotateUp(Math.PI/4);
				controls.target.set(
					camera.position.x + 0.1,
					camera.position.y,
					camera.position.z
				);
				controls.noZoom = true;
				controls.noPan = true;

				var setOrientationControls = function(e) {
					if(!e.alpha) {
						return;
					}
					console.log("rotated");

					controls = new THREE.DeviceOrientationControls(camera, true);
					controls.connect();
					controls.update();

					renderer.domElement.addEventListener('click', fullscreen, false);
					//container.firstChild.addEventListener('click', fullscreen, false);
					window.removeEventListener('deviceorientation', setOrientationControls, true);
				}
				//https://developer.mozilla.org/en-US/docs/Web/API/Detecting_device_orientation
				window.addEventListener('deviceorientation', setOrientationControls, true);

				var skyGeo = new THREE.BoxGeometry(5000,5000,5000);
				var materialArray = [];
					materialArray.push( new THREE.MeshBasicMaterial({ 
						map: THREE.ImageUtils.loadTexture("./img/MainSkyBox/left.jpg"),
						//render on inner side of cube
						side: THREE.BackSide
					}));
					materialArray.push( new THREE.MeshBasicMaterial({ 
						map: THREE.ImageUtils.loadTexture("./img/MainSkyBox/right.jpg"),
						side: THREE.BackSide
					}));
					materialArray.push( new THREE.MeshBasicMaterial({ 
						map: THREE.ImageUtils.loadTexture("./img/MainSkyBox/up.jpg"),
						side: THREE.BackSide
					}));
					materialArray.push( new THREE.MeshBasicMaterial({ 
						map: THREE.ImageUtils.loadTexture("./img/MainSkyBox/bottom.jpg"),
						side: THREE.BackSide
					}));
					materialArray.push( new THREE.MeshBasicMaterial({ 
						map: THREE.ImageUtils.loadTexture("./img/MainSkyBox/front.jpg"),
						side: THREE.BackSide
					}));
					materialArray.push( new THREE.MeshBasicMaterial({ 
						map: THREE.ImageUtils.loadTexture("./img/MainSkyBox/back.jpg"),
						side: THREE.BackSide
					}));
				var skyMaterial = new THREE.MeshFaceMaterial(materialArray);
				var skyBox = new THREE.Mesh(skyGeo, skyMaterial);
				scene.add(skyBox);

				var loader =  new THREE.JSONLoader();
				loader.load("./3D/Rutgers.json", function(geometry, materials) {
					var material = new THREE.MeshLambertMaterial({color: 0xcf0a2c});
					var obj = new THREE.Mesh(geometry, material);
					obj.position.x = 2;
					obj.position.z = -10;
					obj.rotateX(90);
					scene.add(obj);
				});

				loader.load("./3D/250.json", function(geometry, materials) {
					var material = new THREE.MeshLambertMaterial({color: 0x989999});
					var obj = new THREE.Mesh(geometry, material);
					obj.position.x = 2;
					obj.position.z = -10;
					obj.rotateX(90);
					scene.add(obj);
				});

				geometry = new THREE.BoxGeometry(2,2,2);
				material = new THREE.MeshBasicMaterial({color: 0x00ffaa});
				cube = new THREE.Mesh(geometry, material);
				scene.add(cube);
				cube.position.x = 2;
				cube.position.z = -15;

				cube2 = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({color: 0x8888cc}));
				scene.add(cube2);
				cube2.position.x = -2;
				cube2.position.z = -10;

				projectGroup = [];
				projectGroup.push(cube);
				projectGroup.push(cube2);


				window.addEventListener('resize', resize, false);
				setTimeout(resize, 1);
			}

			var escapeFullScreen = function() {
				if(render.domElement.exitFullscreen) {
					renderer.domElement.exitFullscreen();
				}
				else if(renderer.domElement.mozCancelFullScreen){
					renderer.domElement.mozCancelFullScreen();
				}
				else if(renderer.domElement.msExitFullscreen) {
					renderer.domElement.msExitFullscreen();
				}
				else if(renderer.domElement.webkitExitFullscreen) {
					renderer.domElement.webkitExitFullscreen();
				}
				
				renderer.domElement.removeEventListener('click', escapeFullScreen, false);
				renderer.domElement.addEventListener('click', fullscreen, false);
			}
			
			var fullscreen = function() {
				//https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API
				if(renderer.domElement.requestFullscreen) {
					renderer.domElement.requestFullscreen();
				}
				else if(renderer.domElement.msRequestFullscreen) {
					renderer.domElement.msRequestFullscreen();
				}
				else if (renderer.domElement.mozRequestFullScreen) {
					renderer.domElement.mozRequestFullScreen();
				}
				else if(renderer.domElement.webkitRequestFullscreen) {
					renderer.domElement.webkitRequestFullscreen();
				}
				//renderer.domElement.removeEventListener('click', fullscreen, false);
				//renderer.domElement.addEventListener('click', escapeFullScreen, false);
			}

			var resize = function() {
				camera.aspect = window.innerWidth/window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(window.innerWidth, window.innerHeight);
				effect.setSize(window.innerWidth, window.innerHeight);
			}

			var update = function(dt) {
				resize();

				camera.updateProjectionMatrix();

				controls.update(dt);
			}
			
			var render = function(dt) {
				cube.rotation.x += 0.01;
				cube.rotation.y += 0.01;

				cube2.rotation.x += 0.01;
				cube2.rotation.y += 0.01;

				raycaster.setFromCamera( mouse, camera);

				var intersects = raycaster.intersectObjects(projectGroup);
				for(var i = 0; i < intersects.length; i++) {
					intersects[i].object.material.color.set(0xffaaff);
				}

				effect.render(scene, camera);
			}

			var animate = function(t) {
				requestAnimationFrame(animate);

				update(clock.getDelta());	
				render(clock.getDelta());
			}

			create();
			animate();
		}
	</script>
</body>
</html>
